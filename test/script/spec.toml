#:schema ../../src/schema.json
[[imports]]
importer = "vault"
arguments.path = "secret/script"
arguments.allow_fail = true

[[exports]]
exporter = "vault"
arguments.path = "secret/script"

[[generations]]
generator = "script"
arguments.name = "key-script"
arguments.text = '''
def main [renew: bool]: nothing -> nothing {
  let key = (openssl genpkey -algorithm RSA)
  if $renew {
    $key | save -f "key"
  } else {
    $key | try { save "key" }
  }
  chmod 600 "key"
}
'''

[[generations]]
generator = "age-key"

[generations.arguments]
public = "age.txt.pub"
private = "age.txt"

[[generations]]
generator = "sops"

[generations.arguments]
age = "age.txt.pub"
public = "sops.yaml.pub"
private = "sops.yaml"
renew = true

[generations.arguments.secrets]
key-script = "key-script"
key = "key"
